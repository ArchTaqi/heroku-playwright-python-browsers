#!/usr/bin/env bash

# taken from https://github.com/playwright-community/heroku-playwright-buildpack/blob/master/bin/compile
set -e

BUILD_DIR=$1
ENV_DIR=$3

export_env_dir() {
  acceptlist_regex='(BUILDPACK_BROWSERS_INSTALL_PATH|PLAYWRIGHT_BUILDPACK_BROWSERS)'
  denylist_regex='^(PATH|GIT_DIR|CPATH|CPPATH|LD_PRELOAD|LIBRARY_PATH)$'
  if [ -d "$ENV_DIR" ]; then
    for e in $(ls $ENV_DIR); do
      echo "$e" | grep -E "$acceptlist_regex" | grep -qvE "$denylist_regex" &&
      export "$e=$(cat $ENV_DIR/$e)"
      :
    done
  fi
}

export_env_dir

# modify the installation location
if [ -z "$BUILDPACK_BROWSERS_INSTALL_PATH" ]; then
  BUILDPACK_BROWSERS_INSTALL_PATH="/browsers"
fi

if [ -z "$PLAYWRIGHT_BUILDPACK_BROWSERS" ]; then
  # follow format of  https://github.com/playwright-community/heroku-playwright-buildpack/blob/master/bin/compile
  SUPPORTED_BROWSERS=${PLAYWRIGHT_BUILDPACK_BROWSERS:-chromium,firefox,webkit}
fi

export PLAYWRIGHT_BROWSERS_PATH=$BUILD_DIR/$BUILDPACK_BROWSERS_INSTALL_PATH
echo "-----> BROWSERS_INSTALL_PATH is $BUILDPACK_BROWSERS_INSTALL_PATH"
echo "-----> Browsers will be installed in $PLAYWRIGHT_BROWSERS_PATH"
echo "-----> Installing Playwright executables (env: PLAYWRIGHT_BUILDPACK_BROWSERS) for ${SUPPORTED_BROWSERS} (formatted value for command line is '${SUPPORTED_BROWSERS//,/ }')."
playwright install ${SUPPORTED_BROWSERS//,/ }
echo "-----> Installation done"

# copy the buildpack's heroku-playwright-python-browsers-defaults.sh over to the build pack
cat ./heroku-playwright-python-browsers-defaults.sh
cp ./heroku-playwright-python-browsers-defaults.sh $BUILD_DIR/.profile.d/heroku-playwright-python-browsers-defaults.sh