#!/usr/bin/env bash

# taken from https://github.com/playwright-community/heroku-playwright-buildpack/blob/master/bin/compile
set -e

BUILD_DIR=$1
ENV_DIR=$3

# modify the installation location
if [ -z "$BUILDPACK_BROWSERS_INSTALL_PATH" ]; then
  BUILDPACK_BROWSERS_INSTALL_PATH="/browsers"
fi

if [ -z "$PLAYWRIGHT_BUILDPACK_BROWSERS" ]; then
  # follow format of  https://github.com/playwright-community/heroku-playwright-buildpack/blob/master/bin/compile
  SUPPORTED_BROWSERS=${PLAYWRIGHT_BUILDPACK_BROWSERS:-chromium,firefox,webkit}
fi

export PLAYWRIGHT_BROWSERS_PATH=$BUILD_DIR/$BUILDPACK_BROWSERS_INSTALL_PATH
echo "-----> BROWSERS_INSTALL_PATH is $BUILDPACK_BROWSERS_INSTALL_PATH"
echo "-----> Browsers will be installed in $PLAYWRIGHT_BROWSERS_PATH"
echo "----->Installing Playwright executables (env: PLAYWRIGHT_BUILDPACK_BROWSERS) for ${SUPPORTED_BROWSERS//,/ }."
playwright install ${SUPPORTED_BROWSERS//,/ }
echo "-----> Installation done"

# export the file path as a ENV
CHROMIUM_EXECUTABLE_PATH=${find ~+ -type f -name "chrome"}
FIREFOX_EXECUTABLE_PATH=${find ~+ -type f -name "geckodriver"}
WEBKIT_EXECUTABLE_PATH=${find ~+ -type f -name "webkit"}

echo "----> CHROMIUM_EXECUTABLE_PATH is $CHROMIUM_EXECUTABLE_PATH"
echo "----> FIREFOX_EXECUTABLE_PATH is $FIREFOX_EXECUTABLE_PATH"
echo "----> WEBKIT_EXECUTABLE_PATH is $WEBKIT_EXECUTABLE_PATH"

if [ -v "$CHROMIUM_EXECUTABLE_PATH" ]; then
  echo $CHROMIUM_EXECUTABLE_PATH > $ENV_DIR/CHROMIUM_EXECUTABLE_PATH
fi